name: Deploy to App Engine

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Auth to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      
    - name: Update app.yaml
      run: |
        # Modify app.yaml inline
        cat > app.yaml << EOL
        runtime: python39
        instance_class: F2
        entrypoint: gunicorn -b :$PORT main:app
        
        handlers:
          - url: /static
            static_dir: static
          - url: /.*
            script: auto
        
        env_variables:
          ENVIRONMENT: "production"
          SECRET_KEY: "igorek_sk"
          GOOGLE_CLIENT_ID: "${{ secrets.GCP_CLIENT_ID }}"
          GOOGLE_CLIENT_SECRET: "${{ secrets.GCP_CLIENT_SECRET }}"
        EOL
    
    - name: Deploy to App Engine
      run: |
        gcloud app deploy --quiet
